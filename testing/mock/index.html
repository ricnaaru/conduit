<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Mocking Services - Conduit</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../style/css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Mocking Services";
        var mkdocs_page_input_path = "testing/mock.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-41269877-2', 'aqueduct.io');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Conduit
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="" href="../../index.md">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../core_concepts/">Core Concepts</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../getting_started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../tour/">Tour</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../best_practices/">Best Practices</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../intellij.md">IntelliJ IDEA Templates</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorial</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/getting-started/">1. Getting Started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/executing-queries/">2. Reading from a Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/storing-data/">3. Storing Data in a Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/writing-tests/">4. Configuration and Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/oauth2/">5. Authentication and Authorization</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Snippets</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/http/">HTTP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/orm/">ORM</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/auth/">Authentication and Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/test/">Testing</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Application Configuration and Behavior</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../application/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/channel/">Starting and Stopping Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/configure/">Configuring an Application and its Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/structure/">Application and Project Structure</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/threading/">Multi-threading</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Handling HTTP Requests</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/controller/">Handling Requests and Sending Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/request_and_response/">Serializing Request and Response Bodies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/routing/">Routing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/resource_controller/">Request Binding with Resource Controllers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/serving_files/">Serving Files and Caching</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/websockets/">Websockets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/file_upload/">Uploading Files</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Databases and ORM</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../db/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/connecting/">Connecting to a Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/modeling_data/">Modeling Data and Relationships</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/serialization/">Serialization and Deserialization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/executing_queries/">Basic Queries</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/advanced_queries/">Advanced Queries</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/transactions/">Transactions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/validations/">Validations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/db_tools/">Migration and Tooling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/json_columns/">JSON Document Storage</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Authorization and OAuth 2.0</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../auth/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/server/">Setting up Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/authorizer/">Protecting Routes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/controllers/">Issuing Access Tokens</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/cli/">Managing OAuth 2.0 Clients</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/auth_scopes/">OAuth 2.0 Scoping</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/what_is_oauth/">What is OAuth 2.0?</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Development and Testing</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="" href="../index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/">Writing Tests</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../mixins/">Testing with the ORM and OAuth 2.0</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../debugger/">Using the Debugger</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../clients/">Developing Client Applications</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Mocking Services</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#using-a-mockhttpserver">Using a MockHTTPServer</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#configuring-a-mockhttpserver">Configuring a MockHTTPServer</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: OpenAPI Documentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../openapi/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/cli/">Creating an OpenAPI Document</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/components/">Documenting Components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/endpoint/">Documenting Endpoint Controllers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/middleware/">Documenting Middleware Controllers</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Command-line Tooling</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../cli/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/create/">Creating Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/running/">Running Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/document/">Generating an OpenAPI/Swagger Specification</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../deploy/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/build/">Creating a Conduit Executable</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_local/">Deploy Locally (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_docker/">Deploying with Docker and Kubernetes (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_heroku/">Deploy on Heroku (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_aws/">Deploy on AWS (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/script/">Deploying without aqueduct serve (VM)</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Conduit</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Guide: Development and Testing &raquo;</li>
      <li>Mocking Services</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/stablekernel/aqueduct/edit/docs/source/source/docs/testing/mock.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="mocking-external-services">Mocking External Services</h1>
<p>A Conduit application often communicates with another server. For example, an application might make requests to the GitHub API to collect analytics about a team's workflow. When running automated tests, consuming the actual GitHub API isn't feasible - because GitHub will probably rate limit you and because the data being returned is constantly changing.</p>
<p>To solve this problem, you can create "mocks" of a service during testing. Conduit has two testing utilities for this purpose - <code>MockServer</code> and <code>MockHTTPServer</code> - in the <code>conduit/test</code> library.</p>
<h2 id="using-a-mockhttpserver">Using a MockHTTPServer</h2>
<p>When testing your application, you send it requests using a <code>TestClient</code>. As part of the request handling logic, your application might issue requests to some other server. <code>MockHTTPServer</code> allows you to validate that the request your application sent was correct and gives you control what the responses are to those requests. For example, <code>githubMock</code> is an instance of <code>MockHTTPServer</code> in the following test, which ensures that the request was constructed correctly:</p>
<pre class="codehilite"><code class="language-dart">test(&quot;Will get correct user from GitHub&quot;, () async {
  var response =
    await app.client.authenticatedRequest(&quot;/github_profile/fred&quot;).get();

  var requestSentByYourApplicationToGitHub = await githubMock.next();
  expect(requestSentByYourApplicationToGitHub.method, &quot;GET&quot;);
  expect(requestSentByYourApplicationToGitHub.path, &quot;/users/search?name=fred&quot;);
});
</code></pre>

<p>In the above code, we are expecting that anytime the request <code>GET /github_profile/fred</code> is sent to your application, that it turns around and searches for a user in GitHub's API. This test ensures that we have correctly translated our request to a request to be made to the GitHub API. If no request was made - because of a programmer error - this test would fail because the <code>Future</code> returned from <code>githubMock.next()</code> would never complete. There is no next request, because none was ever delivered!</p>
<p>By default, any request sent to a <code>MockHTTPServer</code> is a 200 OK Response with an empty body. You may change this behavior by queuing responses in a mock server.</p>
<pre class="codehilite"><code class="language-dart">test(&quot;Will get correct user from GitHub&quot;, () async {
  githubMock.queueResponse(new Response.ok({&quot;id&quot;: 1, &quot;name&quot;: &quot;fred&quot;}));

  var response =
    await app.client.authenticatedRequest(&quot;/github_profile/fred&quot;).get();
  expect(response, hasResponse(200, partial({
    &quot;id&quot;: 1,
    &quot;name&quot;: &quot;fred&quot;
  })))
});
</code></pre>

<p>In the above code, <code>queueResponse</code> adds a 200 OK Response to the mock server queue with a specific body. The mock server will send that response for the next request it receives. In the implementation of <code>/github_profile/fred</code>, your application sends a <code>GET /users/search?name=fred</code> to the GitHub API - except the GitHub API is your mock server, and it returns the response you queued instead. Thus, the queued up response is the expected response of the GitHub API.</p>
<p>After the request completes, the response is removed from the queue and subsequent responses will go back to the default. You may queue as many responses as you like. You may also simulate a failed request - one that never gets a response - like so:</p>
<pre class="codehilite"><code class="language-dart">mockServer.queueResponse(MockHTTPServer.mockConnectionFailureResponse);
</code></pre>

<p>You may also subclass <code>MockHTTPServer</code> and override its <code>open</code> method to add logic to determine the response. Please see the implementation of <code>MockHTTPServer.open</code> for more details.</p>
<h2 id="configuring-a-mockhttpserver">Configuring a MockHTTPServer</h2>
<p>A <code>MockHTTPServer</code> is created when setting up tests. It must be closed when tearing down tests. If you use the same mock server to across all tests (e.g., open it in <code>setUpAll</code>), make sure to clear it after each test:</p>
<pre class="codehilite"><code class="language-dart">import 'package:conduit/test.dart';

void main() {
  var mockServer = new MockHTTPServer(4000);

  setUpAll(() async {
    await mockServer.open();
  });

  tearDownAll(() async {
    await mockServer.close();
  });

  tearDown(() async {
    mockServer.clear();
  });
}
</code></pre>

<p>An instance of <code>MockHTTPServer</code> listens on localhost on a specific port. An application that makes testable external service requests should provide the base URI for those services in a configuration file. The URI for that service in the <a href="../../application/configure/">configuration file used during testing</a> should point at localhost and a specific port. For example, if a deployed <code>config.yaml</code> file has the following key-values:</p>
<pre class="codehilite"><code class="language-text">github:
  baseURL: https://api.github.com/
</code></pre>

<p>Then <code>config.src.yaml</code> would have:</p>
<pre class="codehilite"><code class="language-text">github:
  baseURL: http://localhost:4000/
</code></pre>

<p>Your application reads this configuration file and injects the base URL into the service that will execute requests.</p>
<pre class="codehilite"><code class="language-dart">class AppConfiguration extends Configuration {
  AppConfiguration(String fileName) : super.fromFile(fileName);

  APIConfiguration github;
}

class AppApplicationChannel extends ApplicationChannel {
  @override
  Future prepare() async {
    var config = new AppConfiguration(options.configurationFilePath);

    githubService = new GitHubService(baseURL: config.github.baseURL);
  }
}
</code></pre>

<p>Note that <code>APIConfiguration</code> is an existing type and is meant for this purpose.</p>
<p>Also note that the testing strategy for database connections is <em>not</em> to use a mock but to use a temporary, local database that is set up and torn down during tests. This is possible because you own the data model generating code - whereas you probably don't have access to an external service's development API.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../clients/" class="btn btn-neutral float-left" title="Developing Client Applications"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../openapi/cli/" class="btn btn-neutral float-right" title="Creating an OpenAPI Document">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Built by Stable Kernel</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/stablekernel/aqueduct" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../clients/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../openapi/cli/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
