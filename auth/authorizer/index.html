<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Protecting Routes - Conduit</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../style/css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Protecting Routes";
        var mkdocs_page_input_path = "auth/authorizer.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Conduit
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="" href="../../index.md">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../core_concepts/">Core Concepts</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../getting_started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../tour/">Tour</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../best_practices/">Best Practices</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../intellij.md">IntelliJ IDEA Templates</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorial</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/getting-started/">1. Getting Started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/executing-queries/">2. Reading from a Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/storing-data/">3. Storing Data in a Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/writing-tests/">4. Configuration and Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/oauth2/">5. Authentication and Authorization</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Snippets</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/http/">HTTP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/orm/">ORM</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/auth/">Authentication and Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/test/">Testing</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Application Configuration and Behavior</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../application/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/channel/">Starting and Stopping Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/configure/">Configuring an Application and its Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/structure/">Application and Project Structure</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/threading/">Multi-threading</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Handling HTTP Requests</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/controller/">Handling Requests and Sending Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/request_and_response/">Serializing Request and Response Bodies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/routing/">Routing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/resource_controller/">Request Binding with Resource Controllers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/serving_files/">Serving Files and Caching</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/websockets/">Websockets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/file_upload/">Uploading Files</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Databases and ORM</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../db/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/connecting/">Connecting to a Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/modeling_data/">Modeling Data and Relationships</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/serialization/">Serialization and Deserialization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/executing_queries/">Basic Queries</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/advanced_queries/">Advanced Queries</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/transactions/">Transactions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/validations/">Validations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/db_tools/">Migration and Tooling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/json_columns/">JSON Document Storage</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Authorization and OAuth 2.0</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="" href="../index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../server/">Setting up Authorization</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Protecting Routes</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#authorizer-and-oauth-20-scope">Authorizer and OAuth 2.0 Scope</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#authorization-objects">Authorization Objects</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-authorizers-without-authserver">Using Authorizers Without AuthServer</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../controllers/">Issuing Access Tokens</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cli/">Managing OAuth 2.0 Clients</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../auth_scopes/">OAuth 2.0 Scoping</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../what_is_oauth/">What is OAuth 2.0?</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Development and Testing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../testing/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/tests/">Writing Tests</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/mixins/">Testing with the ORM and OAuth 2.0</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/debugger/">Using the Debugger</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/clients/">Developing Client Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/mock/">Mocking Services</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: OpenAPI Documentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../openapi/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/cli/">Creating an OpenAPI Document</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/components/">Documenting Components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/endpoint/">Documenting Endpoint Controllers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/middleware/">Documenting Middleware Controllers</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Command-line Tooling</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../cli/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/create/">Creating Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/running/">Running Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/document/">Generating an OpenAPI/Swagger Specification</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../deploy/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/build/">Creating a Conduit Executable</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_local/">Deploy Locally (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_docker/">Deploying with Docker and Kubernetes (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_heroku/">Deploy on Heroku (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_aws/">Deploy on AWS (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/script/">Deploying without aqueduct serve (VM)</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Conduit</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Guide: Authorization and OAuth 2.0 &raquo;</li>
      <li>Protecting Routes</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/conduit-dart/conduit/edit/docs/source/source/docs/auth/authorizer.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="securing-routes-with-authorizer">Securing Routes with Authorizer</h1>
<p>Instances of <code>Authorizer</code> are added to an application channel to verify HTTP request's authorization information before passing the request onwards. They protect channel access and typically come right after <code>route</code>. Here's an example:</p>
<pre class="codehilite"><code class="language-dart">@override
Controller get entryPoint {
  final router = Router();

  router
    .route(&quot;/protected&quot;)
    .link(() =&gt; Authorizer.bearer(authServer))
    .link(() =&gt; ProtectedController());

  router
    .route(&quot;/other&quot;)
    .link(() =&gt; Authorizer.basic(authServer))
    .link(() =&gt; OtherProtectedController());

  return router;
}
</code></pre>

<p>An <code>Authorizer</code> parses the Authorization header of an HTTP request. The named constructors of <code>Authorizer</code> indicate the required format of Authorization header. The <code>Authorization.bearer()</code> constructor expects an OAuth 2.0 bearer token in the header, which has the following format:</p>
<pre class="codehilite"><code class="language-text">Authorization: Bearer 768iuzjkx82jkasjkd9z9
</code></pre>

<p><code>Authorizer.basic</code> expects HTTP Basic Authentication, where the username and password are joined with the colon character (<code>:</code>) and Base 64-encoded:</p>
<pre class="codehilite"><code class="language-text">// 'dXNlcjpwYXNzd29yZA==' is 'user:password'
Authorization: Basic dXNlcjpwYXNzd29yZA==
</code></pre>

<p>If the header can't be parsed, doesn't exist or is in the wrong format, an <code>Authorizer</code> responds to the request with a 401 status code and prevents the next controller from receiving the request.</p>
<p>Once parsed, an <code>Authorizer</code> sends the information - either the bearer token, or the username and password - to its <code>AuthServer</code> for verification. If the <code>AuthServer</code> rejects the authorization info, the <code>Authorizer</code> responds to the request with a 401 status code and prevents the next controller from receiving the request. Otherwise, the request continues to the next controller.</p>
<p>For <code>Authorizer.bearer</code>, the value in a request's header must be a valid, unexpired access token. These types of authorizers are used when an endpoint requires a logged in user.</p>
<p>For <code>Authorizer.basic</code> authorizers, credentials are verified by finding an OAuth 2.0 client identifier and ensuring its client secret matches. Routes with this type of authorizer are known as <em>client authenticated</em> routes. These types of authorizers are used when an endpoint requires a valid client application, but not a logged in user.</p>
<h2 id="authorizer-and-oauth-20-scope">Authorizer and OAuth 2.0 Scope</h2>
<p>An <code>Authorizer</code> may restrict access to controllers based on the scope of the request's bearer token. By default, an <code>Authorizer.bearer</code> allows any valid bearer token to pass through it. If desired, an <code>Authorizer</code> is initialized with a list of required scopes. A request may only pass the <code>Authorizer</code> if it has access to <em>all</em> scopes listed in the <code>Authorizer</code>. For example, the following requires at least <code>user:posts</code> and <code>location</code> scope:</p>
<pre class="codehilite"><code class="language-dart">router
  .route(&quot;/checkin&quot;)
  .link(() =&gt; Authorizer.bearer(authServer, scopes: [&quot;user:posts&quot;, &quot;location&quot;]))
  .link(() =&gt; CheckInController());
</code></pre>

<p>Note that you don't have to use an <code>Authorizer</code> to restrict access based on scope. A controller has access to scope information after the request has passed through an <code>Authorizer</code>, so it can use the scope to make more granular authorization decisions.</p>
<h2 id="authorization-objects">Authorization Objects</h2>
<p>A bearer token represents a granted authorization - at some point in the past, a user provided their credentials and the token is the proof of that. When a bearer token is sent in the authorization header of an HTTP request, the application can look up which user the token is for and the client application it was issued for. This information is stored in an instance of <code>Authorization</code> after the token has been verified and is assigned to <code>Request.authorization</code>.</p>
<p>Controllers protected by an <code>Authorizer</code> can access this information to further determine their behavior. For example, a social networking application might have a <code>/news_feed</code> endpoint protected by an <code>Authorizer</code>. When an authenticated user makes a request for <code>/news_feed</code>, the controller will return that user's news feed. It can determine this by using the <code>Authorization</code>:</p>
<pre class="codehilite"><code class="language-dart">class NewsFeedController extends ResourceController {
  NewsFeedController(this.context);

  ManagedContext context;

  @Operation.get()
  Future&lt;Response&gt; getNewsFeed() async {
    var forUserID = request.authorization.ownerID;

    var query = Query&lt;Post&gt;(context)
      ..where((p) =&gt; p.author).identifiedBy(forUserID);

    return Response.ok(await query.fetch());
  }
}
</code></pre>

<p>In the above controller, it's impossible for a user to access another user's posts.</p>
<p><code>Authorization</code> objects also retain the scope of an access token so that a controller can make more granular decisions about the information/action in the endpoint. Checking whether an <code>Authorization</code> has access to a particular scope is accomplished by either looking at the list of its <code>scopes</code> or using <code>authorizedForScope</code>:</p>
<pre class="codehilite"><code class="language-dart">class NewsFeedController extends ResourceController {
  NewsFeedController(this.context);

  ManagedContext context;

  @Operation.get()
  Future&lt;Response&gt; getNewsFeed() async {
    if (!request.authorization.authorizedForScope(&quot;user:feed&quot;)) {
      return Response.unauthorized();
    }

    var forUserID = request.authorization.ownerID;

    var query = Query&lt;Post&gt;(context)
      ..where((p) =&gt; p.author).identifiedBy(forUserID);

    return Response.ok(await query.fetch());
  }
}
</code></pre>

<h2 id="using-authorizers-without-authserver">Using Authorizers Without AuthServer</h2>
<p>Throughout this guide, the argument to an instance of <code>Authorizer</code> has been referred to as an <code>AuthServer</code>. This is true - but only because <code>AuthServer</code> implements <code>AuthValidator</code>. <code>AuthValidator</code> is an interface for verifying bearer tokens and username/password credentials.</p>
<p>You may use <code>Authorizer</code> without using <code>AuthServer</code>. For example, an application that doesn't use OAuth 2.0 could provide its own <code>AuthValidator</code> interface to simply verify the username and password of every request:</p>
<pre class="codehilite"><code class="language-dart">class BasicValidator implements AuthValidator {
  @override
  FutureOr&lt;Authorization&gt; validate&lt;T&gt;(AuthorizationParser&lt;T&gt; parser, T authorizationData, {List&lt;AuthScope&gt; requiredScope}) {}
    var user = await userForName(usernameAndPassword.username);
    if (user.password == hash(usernameAndPassword.password, user.salt)) {
      return Authorization(...);
    }

    // Will end up creating a 401 Not Authorized Response
    return null;
  }
}
</code></pre>

<p>The <code>validate</code> method must return an <code>Authorization</code> if the credentials are valid, or null if they are not. The <code>parser</code> lets the validator know the format of the Authorization header (e.g., 'Basic' or 'Bearer') and <code>authorizationData</code> is the meaningful information in that header. There are two concrete types of <code>AuthorizationParser&lt;T&gt;</code>: <code>AuthorizationBasicParser</code> and <code>AuthorizationBearerParser</code>. The authorization data for a basic parser is an instance of <code>AuthBasicCredentials</code> that contain the username and password, while the bearer parser's authorization data is the bearer token string.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../server/" class="btn btn-neutral float-left" title="Setting up Authorization"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../controllers/" class="btn btn-neutral float-right" title="Issuing Access Tokens">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Built by Stable Kernel</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/conduit-dart/conduit" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../server/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../controllers/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
