<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Setting up Authorization - Conduit</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../style/css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Setting up Authorization";
        var mkdocs_page_input_path = "auth/server.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Conduit
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="" href="../../index.md">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../core_concepts/">Core Concepts</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../getting_started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../tour/">Tour</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../best_practices/">Best Practices</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../intellij.md">IntelliJ IDEA Templates</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorial</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/getting-started/">1. Getting Started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/executing-queries/">2. Reading from a Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/storing-data/">3. Storing Data in a Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/writing-tests/">4. Configuration and Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut/oauth2/">5. Authentication and Authorization</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Snippets</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/http/">HTTP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/orm/">ORM</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/auth/">Authentication and Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/test/">Testing</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Application Configuration and Behavior</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../application/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/channel/">Starting and Stopping Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/configure/">Configuring an Application and its Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/structure/">Application and Project Structure</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/threading/">Multi-threading</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Handling HTTP Requests</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/controller/">Handling Requests and Sending Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/request_and_response/">Serializing Request and Response Bodies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/routing/">Routing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/resource_controller/">Request Binding with Resource Controllers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/serving_files/">Serving Files and Caching</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/websockets/">Websockets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/file_upload/">Uploading Files</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Databases and ORM</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../db/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/connecting/">Connecting to a Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/modeling_data/">Modeling Data and Relationships</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/serialization/">Serialization and Deserialization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/executing_queries/">Basic Queries</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/advanced_queries/">Advanced Queries</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/transactions/">Transactions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/validations/">Validations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/db_tools/">Migration and Tooling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/json_columns/">JSON Document Storage</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Authorization and OAuth 2.0</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="" href="../index.md">Overview</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Setting up Authorization</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#creating-instances-of-authserver-and-authserverdelegate">Creating Instances of AuthServer and AuthServerDelegate</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-managedauthdelegate">Using ManagedAuthDelegate</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#configuring-the-database">Configuring the Database</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../authorizer/">Protecting Routes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../controllers/">Issuing Access Tokens</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cli/">Managing OAuth 2.0 Clients</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../auth_scopes/">OAuth 2.0 Scoping</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../what_is_oauth/">What is OAuth 2.0?</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Development and Testing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../testing/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/tests/">Writing Tests</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/mixins/">Testing with the ORM and OAuth 2.0</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/debugger/">Using the Debugger</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/clients/">Developing Client Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/mock/">Mocking Services</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: OpenAPI Documentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../openapi/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/cli/">Creating an OpenAPI Document</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/components/">Documenting Components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/endpoint/">Documenting Endpoint Controllers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/middleware/">Documenting Middleware Controllers</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Command-line Tooling</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../cli/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/create/">Creating Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/running/">Running Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/document/">Generating an OpenAPI/Swagger Specification</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../deploy/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/build/">Creating a Conduit Executable</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_local/">Deploy Locally (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_docker/">Deploying with Docker and Kubernetes (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_heroku/">Deploy on Heroku (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_aws/">Deploy on AWS (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/script/">Deploying without aqueduct serve (VM)</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Conduit</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Guide: Authorization and OAuth 2.0 &raquo;</li>
      <li>Setting up Authorization</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/conduit-dart/conduit/edit/docs/source/source/docs/auth/server.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="creating-authservers-to-authenticate-and-authorize">Creating AuthServers to Authenticate and Authorize</h1>
<p>An <code>AuthServer</code> is a service that handles creating, verifying and refreshing authorization tokens. You create an <code>AuthServer</code> in your application channel and inject into types that deal with authorization. This types include:</p>
<ul>
<li><code>Authorizer</code>: middleware controller that protects endpoint controllers from unauthorized access</li>
<li><code>AuthController</code>: endpoint controller that grants access tokens</li>
<li><code>AuthCodeController</code>: endpoint controller that grants authorization codes to be exchanged for access tokens</li>
</ul>
<p>An <code>AuthServer</code> must persist the data it uses and creates - like client identifiers and access tokens. Storage is often performed by a database, but it can be in memory, a cache or some other medium. Because of the many different storage mediums, an <code>AuthServer</code> doesn't perform any storage itself - it relies on an instance of <code>AuthServerDelegate</code> specific to your application. This allows storage to be independent of verification logic.</p>
<h2 id="creating-instances-of-authserver-and-authserverdelegate">Creating Instances of AuthServer and AuthServerDelegate</h2>
<p><code>AuthServerDelegate</code> is an interface that an <code>AuthServer</code> uses to handle storage of client identifiers, tokens and other authorization artifacts. An <code>AuthServer</code> must be created with a concrete implementation of <code>AuthServerDelegate</code>. Conduit contains a concrete implementation of <code>AuthServerDelegate</code> that uses the ORM. It is highly recommended to use this implementation instead of implementing your own storage because it has been thoroughly tested and handles cleaning up expired data correctly.</p>
<p>This concrete implementation is named <code>ManagedAuthDelegate&lt;T&gt;</code>. It exists in a sub-package of Conduit and must be explicitly imported. Here's an example of creating an <code>AuthServer</code> and <code>ManagedAuthDelegate&lt;T&gt;</code>:</p>
<pre class="codehilite"><code class="language-dart">import 'package:conduit/conduit.dart';
import 'package:conduit/managed_auth.dart';

class MyApplicationChannel extends ApplicationChannel {  
  AuthServer authServer;

  @override
  Future prepare() async {
    final context = ManagedContext(...);
    final delegate = ManagedAuthDelegate&lt;User&gt;(context);
    authServer = AuthServer(delegate);
  }

  ...
}
</code></pre>

<p>(Notice that <code>ManagedAuthDelegate</code> has a type argument - this will be covered in the next section.)</p>
<p>While <code>AuthServer</code> has methods for handling authorization tasks, it is rarely used directly. Instead, <code>AuthCodeController</code> and <code>AuthController</code> are hooked up to routes to grant authorization tokens through your application's HTTP API. Instances of <code>Authorizer</code> secure routes in channels. All of these types invoke the appropriate methods on the <code>AuthServer</code>. Here's an example <code>ApplicationChannel</code> subclass that sets up and uses authorization:</p>
<pre class="codehilite"><code class="language-dart">import 'package:conduit/conduit.dart';
import 'package:conduit/managed_auth.dart';

class MyApplicationChannel extends ApplicationChannel {
  AuthServer authServer;
  ManagedContext context;

  @override
  Future prepare() async {
    context = ManagedContext(...);
    final delegate = ManagedAuthDelegate&lt;User&gt;(context);
    authServer = AuthServer(delegate);
  }

  @override
  Controller get entryPoint {
    final router = Router();

    // Set up auth token route- this grants and refresh tokens
    router.route(&quot;/auth/token&quot;).link(() =&gt; AuthController(authServer));

    // Set up auth code route- this grants temporary access codes that can be exchanged for token
    router.route(&quot;/auth/code&quot;).link(() =&gt; AuthCodeController(authServer));

    // Set up protected route
    router
      .route(&quot;/protected&quot;)
      .link(() =&gt; Authorizer.bearer(authServer))
      .link(() =&gt; ProtectedController());

    return router;
  }
}
</code></pre>

<p>For more details on authorization controllers like <code>AuthController</code>, see <a href="../controllers/">Authorization Controllers</a>. For more details on securing routes, see <a href="../authorizer/">Authorizers</a>.</p>
<h2 id="using-managedauthdelegate">Using ManagedAuthDelegate</h2>
<p><code>ManagedAuthDelegate&lt;T&gt;</code> is a concrete implementation of <code>AuthServerDelegate</code>, providing storage of authorization tokens and clients for an <code>AuthServer</code>. Storage is accomplished by Conduit's ORM. <code>ManagedAuthDelegate&lt;T&gt;</code>, by default, is not part of the standard <code>conduit</code> library. To use this class, an application must import <code>package:conduit/managed_auth.dart</code>.</p>
<p>The type argument to <code>ManagedAuthDelegate&lt;T&gt;</code> represents the application's concept of a 'user' or 'account' - OAuth 2.0 terminology would refer to this type as a <em>resource owner</em>. A resource owner must be a <code>ManagedObject&lt;T&gt;</code> subclass that is specific to your application. Its table definition <em>must extend</em> <code>ResourceOwnerTableDefinition</code> and the instance type must implement <code>ManagedAuthResourceOwner&lt;T&gt;</code>, where <code>T</code> is the table definition. A basic definition may look like this:</p>
<pre class="codehilite"><code class="language-dart">class User extends ManagedObject&lt;_User&gt;
    implements _User, ManagedAuthResourceOwner&lt;_User&gt; {
}

class _User extends ResourceOwnerTableDefinition {
  @Column(unique: true)
  String email;
}
</code></pre>

<p>By extending <code>ResourceOwnerTableDefinition</code> in the table definition, the database table has the following four columns:</p>
<ul>
<li>an integer primary key named <code>id</code></li>
<li>a unique string <code>username</code></li>
<li>a password hash</li>
<li>a salt used to generate the password hash</li>
</ul>
<p>A <code>ResourceOwnerTableDefinition</code> also has a <code>ManagedSet</code> of <code>tokens</code> for each token that has been granted on its behalf.</p>
<p>The interface <code>ManagedAuthResourceOwner&lt;T&gt;</code> is a requirement that ensures the type argument is both a <code>ManagedObject&lt;T&gt;</code> and <code>ResourceOwnerTableDefinition</code>, and serves no other purpose than to restrict <code>ManagedAuthDelegate&lt;T&gt;</code>'s type parameter.</p>
<p>This structure allows an application to declare its own 'user' type while still enforcing the needs of Conduit's OAuth 2.0 implementation.</p>
<p>The <code>managed_auth</code> library also declares two <code>ManagedObject&lt;T&gt;</code> subclasses. <code>ManagedAuthToken</code> represents instances of authorization tokens and codes, and <code>ManagedAuthClient</code> represents instances of OAuth 2.0 clients. This means that a Conduit application that uses <code>ManagedAuthDelegate&lt;T&gt;</code> has a minimum of three database tables: users, tokens and clients.</p>
<p><code>ManagedAuthDelegate&lt;T&gt;</code> will delete authorization tokens and codes when they are no longer in use. This is determined by how many tokens a resource owner has and the tokens expiration dates. Once a resource owner acquires more than 40 tokens/codes, the oldest tokens/codes (determined by expiration date) are deleted. Effectively, the resource owner is limited to 40 tokens. This number can be changed when instantiating <code>ManagedAuthDelegate&lt;T&gt;</code>:</p>
<pre class="codehilite"><code class="language-dart">final delegate = ManagedAuthDelegate(context, tokenLimit: 20);
</code></pre>

<h2 id="configuring-the-database">Configuring the Database</h2>
<p><code>ManagedAuthDelegate&lt;T&gt;</code> requires database tables for its users, tokens and clients. Use the <a href="../../db/db_tools/">database command-line tool</a> on your project to generate migration scripts and execute them against a database. This tool will see the declarations for your user type, <code>ManagedAuthToken</code> and <code>ManagedAuthClient</code> and create the appropriate tables.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../db/json_columns/" class="btn btn-neutral float-left" title="JSON Document Storage"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../authorizer/" class="btn btn-neutral float-right" title="Protecting Routes">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Built by Stable Kernel</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/conduit-dart/conduit" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../../db/json_columns/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../authorizer/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
