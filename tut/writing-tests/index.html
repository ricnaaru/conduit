<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>4. Configuration and Testing - Conduit</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../style/css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "4. Configuration and Testing";
        var mkdocs_page_input_path = "tut/writing-tests.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-41269877-2', 'aqueduct.io');
        ga('send', 'pageview');
      </script>
    
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Conduit
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="" href="../../index.md">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../core_concepts/">Core Concepts</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../getting_started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../tour/">Tour</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../best_practices/">Best Practices</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../intellij.md">IntelliJ IDEA Templates</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorial</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../getting-started/">1. Getting Started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../executing-queries/">2. Reading from a Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../storing-data/">3. Storing Data in a Database</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">4. Configuration and Testing</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#application-configuration">Application Configuration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#configuration-template">Configuration Template</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#testing-in-conduit">Testing in Conduit</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#setting-up-your-development-environment">Setting up your Development Environment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#writing-your-first-test">Writing Your First Test</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#writing-more-tests">Writing More Tests</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../oauth2/">5. Authentication and Authorization</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Snippets</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/http/">HTTP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/orm/">ORM</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/auth/">Authentication and Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../snippets/test/">Testing</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Application Configuration and Behavior</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../application/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/channel/">Starting and Stopping Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/configure/">Configuring an Application and its Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/structure/">Application and Project Structure</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../application/threading/">Multi-threading</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Handling HTTP Requests</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/controller/">Handling Requests and Sending Response</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/request_and_response/">Serializing Request and Response Bodies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/routing/">Routing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/resource_controller/">Request Binding with Resource Controllers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/serving_files/">Serving Files and Caching</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/websockets/">Websockets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../http/file_upload/">Uploading Files</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Databases and ORM</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../db/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/connecting/">Connecting to a Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/modeling_data/">Modeling Data and Relationships</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/serialization/">Serialization and Deserialization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/executing_queries/">Basic Queries</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/advanced_queries/">Advanced Queries</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/transactions/">Transactions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/validations/">Validations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/db_tools/">Migration and Tooling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../db/json_columns/">JSON Document Storage</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Authorization and OAuth 2.0</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../auth/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/server/">Setting up Authorization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/authorizer/">Protecting Routes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/controllers/">Issuing Access Tokens</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/cli/">Managing OAuth 2.0 Clients</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/auth_scopes/">OAuth 2.0 Scoping</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../auth/what_is_oauth/">What is OAuth 2.0?</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Development and Testing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../testing/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/tests/">Writing Tests</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/mixins/">Testing with the ORM and OAuth 2.0</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/debugger/">Using the Debugger</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/clients/">Developing Client Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/mock/">Mocking Services</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: OpenAPI Documentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../openapi/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/cli/">Creating an OpenAPI Document</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/components/">Documenting Components</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/endpoint/">Documenting Endpoint Controllers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/middleware/">Documenting Middleware Controllers</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Command-line Tooling</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../cli/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/create/">Creating Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/running/">Running Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/document/">Generating an OpenAPI/Swagger Specification</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide: Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../deploy/index.md">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/build/">Creating a Conduit Executable</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_local/">Deploy Locally (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_docker/">Deploying with Docker and Kubernetes (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_heroku/">Deploy on Heroku (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/deploy_aws/">Deploy on AWS (VM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../deploy/script/">Deploying without aqueduct serve (VM)</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Conduit</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Tutorial &raquo;</li>
      <li>4. Configuration and Testing</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/stablekernel/aqueduct/edit/docs/source/source/docs/tut/writing-tests.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="configuration-and-writing-tests">Configuration and Writing Tests</h1>
<p>We will continue to build on the last chapter's project, <code>heroes</code>, by writing automated tests for it. We will also set up configurable environments for our application.</p>
<h2 id="application-configuration">Application Configuration</h2>
<p>Right now, our application hardcodes its database connection information. This is bad because we want to use a different database when we're testing, running locally and running in production. It's also bad because we'd have to check our database password into version control.</p>
<p>We can create a configuration file to store values like database connection information, and use a different configuration file for each environment. The <code>heroes</code> application needs to be able to configure the username, password, host port and name of the database it uses. Open the file <code>config.yaml</code>, which is empty, and enter the following key-value pairs:</p>
<pre class="codehilite"><code class="language-yaml">database:
  host: localhost
  port: 5432
  username: heroes_user
  password: password
  databaseName: heroes
</code></pre>

<p>These are the same values we used in our application channel. We'll want to replace the hardcoded values with whatever values are in this file. In <code>lib/channel.dart</code>, declare a new class at the bottom of the file:</p>
<pre class="codehilite"><code class="language-dart">class HeroConfig extends Configuration {
  HeroConfig(String path): super.fromFile(File(path));

  DatabaseConfiguration database;
}
</code></pre>

<p>A <code>Configuration</code> subclass declares the expected properties of a configuration file. <code>HeroConfig</code> has one property named <code>database</code> - this matches the name of our top-level key in <code>config.yaml</code>. A <code>DatabaseConfiguration</code> is a built-in configuration type that has properties for <code>host</code>, <code>port</code>, <code>username</code>, <code>password</code> and <code>databaseName</code>. We can load <code>config.yaml</code> into a <code>HeroConfig</code> because they have the same structure and all of the key names match the property names in our configuration types.</p>
<p>!!! tip "Invalid Configuration" If your configuration file and configuration object don't have a matching structure, an error will be thrown when your application starts and tell you which values are missing.</p>
<p>Let's load <code>config.yaml</code> and use its values to set up our database connection by replacing the <code>prepare</code> method in <code>lib/channel.dart</code>:</p>
<pre class="codehilite"><code class="language-dart">@override
Future prepare() async {
  logger.onRecord.listen(
      (rec) =&gt; print(&quot;$rec ${rec.error ?? &quot;&quot;} ${rec.stackTrace ?? &quot;&quot;}&quot;));

  final config = HeroConfig(options.configurationFilePath);
  final dataModel = ManagedDataModel.fromCurrentMirrorSystem();
  final persistentStore = PostgreSQLPersistentStore.fromConnectionInfo(
      config.database.username,
      config.database.password,
      config.database.host,
      config.database.port,
      config.database.databaseName);

  context = ManagedContext(dataModel, persistentStore);
}
</code></pre>

<p>When our application starts, our channel has access to an <code>options</code> property that has the command-line arguments that started the application. By default, the value of <code>configurationFilePath</code> is <code>config.yaml</code> (it corresponds to <code>--config-path</code> in <code>conduit serve</code>). When <code>config.yaml</code> is read, its values are read into a <code>HeroConfig</code> and are used to configure our database connection.</p>
<p>Re-run your application and it'll work exactly the same as it did before - except now, we can substitute databases depending on how we run the application.</p>
<h3 id="configuration-template">Configuration Template</h3>
<p>You shouldn't check <code>config.yaml</code> into version control because it contains sensitive information. However, it is important to check in a <em>configuration source file</em>. A configuration source file has the same structure as <code>HeroConfig</code>, but it has values for your test environment - both locally and with continuous integration tools. It is also used as a template for your deployed configuration files.</p>
<p>!!! tip "Sensitive Information" Use a platform like Heroku or Kubernetes. You can store sensitive information in secured environment variables. You can substitute environment variables in a configuration file by using the variable's name with a <code>$</code> prefix as a value, e.g. <code>password: $DATABASE_PASSWORD</code>.</p>
<p>A configuration source file should be named <code>config.src.yaml</code>, and one currently exists as an empty file in your project. Enter the following configuration into this file:</p>
<pre class="codehilite"><code class="language-dart">database:
  host: localhost
  port: 5432
  username: dart
  password: dart
  databaseName: dart_test
</code></pre>

<p>This file has the expected structure, but has different values for the database information (for a database that we will create shortly). In the next section, we'll use this configuration file to run our automated tests.</p>
<h2 id="testing-in-conduit">Testing in Conduit</h2>
<p>So far, we've tested our application by using a web application. This isn't a good way to test an application. A better way is to write automated test cases. An automated test case not only tests the code you are working on, but makes sure the code you've worked on in the past continues to work as you make changes. A good development practice is to configure <a href="https://travis-ci.com">TravisCI</a> to run all of your tests for every code change.</p>
<p>Because testing is so important, there is a package for writing Conduit application tests. In this chapter, we will use this package to make sure our hero endpoints are working correctly.</p>
<p>!!! note "package:conduit_test" The package <code>conduit_test</code> and <code>test</code> was already added to your <code>pubspec.yaml</code> file as a test dependency by the template generator.</p>
<p>In all Dart applications, a test suite is a Dart script with a <code>main</code> function. In this function, the <code>test</code> function is called multiple times to register expectations. A test passes if all of your expectations are met. An example Dart test looks like this:</p>
<pre class="codehilite"><code class="language-dart">import 'package:test/test.dart';

void main() {
  test(&quot;1+1 = 2&quot;, () {
    // Expect that 1 + 1 = 2
    expect(1 + 1, equals(2));
  });
}
</code></pre>

<h3 id="setting-up-your-development-environment">Setting up your Development Environment</h3>
<p>In <code>config.src.yaml</code>, we target the database <code>dart:dart@localhost:5432/dart_test</code>. This is a 'special' database that is used by all Conduit applications for automated testing (by default). When your application is tested, its tables are temporarily added to this database and then discarded after tests complete. This means that no data is stored in between test runs.</p>
<p>Create this database by running <a href="https://postgresapp.com/documentation/cli-tools.html">psql</a> and enter the following SQL:</p>
<pre class="codehilite"><code class="language-sql">CREATE DATABASE dart_test;
CREATE USER dart WITH createdb;
ALTER USER dart WITH password 'dart';
GRANT all ON database dart_test TO dart;
</code></pre>

<p>!!! tip "dart_test Database" You only have to create this database once per machine, and in any continuous integration scripts. All of your Conduit applications will use this database for automated testing. Fun fact - you can run multiple application's tests simultaneously using this database because the tables only exist for the database connection that created them.</p>
<h3 id="writing-your-first-test">Writing Your First Test</h3>
<p>We will create a test suite to make sure that all hero endpoints return the right data, and make the right changes. Create a new file named <code>test/hero_controller_test.dart</code>.</p>
<p>!!! warning "Test Files Names and Locations" A test file must end in <code>_test.dart</code> and must be in the <code>test/</code> directory of your project, or it won't be run.</p>
<p>At the top of this file, import your application's <em>test harness</em> and enter the following <code>main</code> function:</p>
<pre class="codehilite"><code class="language-dart">import 'harness/app.dart';

void main() {
  final harness = Harness()..install();
}
</code></pre>

<p>A test harness is an object that starts and stops your application when running a test suite, as long as you call its <code>install</code> method. This harness can then send requests to your application, and you can expect that the response is correct. Add a test to the main function that makes sure we get back a 200 OK when we call <code>GET /heroes</code>:</p>
<pre class="codehilite"><code class="language-dart">void main() {
  final harness = Harness()..install();

  test(&quot;GET /heroes returns 200 OK&quot;, () async {
    final response = await harness.agent.get(&quot;/heroes&quot;);
    expectResponse(response, 200);
  });
}
</code></pre>

<p>A harness has an <code>Agent</code> that can send requests to the application it started. Methods like <code>get</code> and <code>post</code> take a path (and optionally headers and a body) and return a response object. This object is used in <code>expectResponse</code> to validate the status code and other values. Tests in Conduit are written in this way: make a request, expect that the response is intended.</p>
<p>Because our application makes database queries, we have to to upload our database schema to the test database before each test. Fortunately, this is something our test harness can also do. In <code>test/harness/app.dart</code>, mixin <code>TestHarnessORMMixin</code> and override two methods:</p>
<pre class="codehilite"><code class="language-dart">class Harness extends TestHarness&lt;HeroesChannel&gt; with TestHarnessORMMixin {
  @override
  ManagedContext get context =&gt; channel.context;

  @override
  Future onSetUp() async {
    await resetData();
  }
}
</code></pre>

<p>The mixin gives our harness the method <code>resetData</code>. This method deletes everything from the test database and uploads the schema in a pristine state. By calling this method in <code>onSetUp</code>, our test harness will reset data before each test.</p>
<p>!!! tip "New Project Templates" Using the <code>-t</code> command-line argument with <code>conduit create</code> allows you to select a template. Templates like <code>db</code> and <code>db_and_auth</code> have a test harness that already mixes in <code>TestHarnessORMMixin</code>.</p>
<p>Now, we can run this test by right-clicking on the <code>main</code> function in <code>hero_controller_test.dart</code> and selecting <code>Run tests in 'hero_controller_test.dart'</code>. A panel will appear that shows the results of your tests. You'll see a green checkmark next to the test in this panel to show that your test succeeded. If your test did not succeed, the reason will be printed to the console. If your test failed because of an error in your code, you will also be able to see the stack trace of the error.</p>
<p>!!! tip "Running Tests" You can also run all of your tests for an application by running <code>pub run test</code> from your project's directory. You can re-run a test with the green play button at the top right corner of the screen, or the keyboard shortcut associated with it (this shortcut varies depending on your installation).</p>
<p>We should expect that more than just the status code is correct. Let's verify that the body is a list, where every element is an object that contains an id and name. Update your test:</p>
<pre class="codehilite"><code class="language-dart">test(&quot;GET /heroes returns 200 OK&quot;, () async {
  final response = await harness.agent.get(&quot;/heroes&quot;);
  expectResponse(response, 200, body: everyElement({
    &quot;id&quot;: greaterThan(0),
    &quot;name&quot;: isString,
  }));
});
</code></pre>

<p>This expectation ensures that the body is a list and that every element is an object with a <code>id</code> greater than 0, and a <code>name</code> that is a string. When expecting a body value, the body is first decoded from its content-type before the expectation. In practice, this means that your JSON response body is deserialized into an object or list. Your expectations of the body are built from Dart objects like <code>List</code> and <code>Object</code> that deserialized from JSON.</p>
<p>!!! tip "Matchers" The function <code>everyElement</code> is a <code>Matcher</code> from <code>package:matcher</code>. There are many types of matchers for all kinds of scenarios, and <code>package:conduit_test</code> includes Conduit-specific matchers. See the <a href="https://www.pub.dev/documentation/conduit_test/latest/">conduit_test API Reference</a> for all Conduit matchers.</p>
<p>This test actually has an error that we will fix in it by using another matcher. Right now, this endpoint returns an <em>empty list</em> because there are no heroes in the database! Let's insert a hero before we make this request, and also expect that there is at least one element in the body. Make sure to import <code>hero.dart</code> at the top of the file!</p>
<pre class="codehilite"><code class="language-dart">import 'package:heroes/model/hero.dart';

import 'harness/app.dart';

void main() {
  final harness = Harness()..install();

  test(&quot;GET /heroes returns 200 OK&quot;, () async {
    final query = Query&lt;Hero&gt;(harness.application.channel.context)
      ..values.name = &quot;Bob&quot;;

    await query.insert();

    final response = await harness.agent.get(&quot;/heroes&quot;);
    expectResponse(response, 200,
        body: allOf([
          hasLength(greaterThan(0)),
          everyElement({
            &quot;id&quot;: greaterThan(0),
            &quot;name&quot;: isString,
          })
        ]));
  });
}
</code></pre>

<p>This test first inserts a hero named 'Bob' before getting all heroes. We compose a matcher where each element has to match the expected list, but also have a length greater than 0. Re-run your tests, and they should still pass.</p>
<h2 id="writing-more-tests">Writing More Tests</h2>
<p>Let's write a few more tests for when we <code>POST /heroes</code>. In the first test, we'll make a mistake on purpose to see how tests fail. Add the following test:</p>
<pre class="codehilite"><code class="language-dart">test(&quot;POST /heroes returns 200 OK&quot;, () async {
  final response = await harness.agent.post(&quot;/heroes&quot;, body: {
    &quot;name&quot;: &quot;Fred&quot;
  });
  expectResponse(response, 200, body: {
    &quot;id&quot;: greaterThan(0),
    &quot;name&quot;: &quot;Bob&quot;
  });
});
</code></pre>

<p>This test creates a hero named 'Fred', but expects that the returned hero has the name 'Bob'. When we run the test, we see this test failure:</p>
<pre class="codehilite"><code class="language-text">Expected: --- HTTP Response ---
          - Status code must be 200
          - Headers can be anything
          - Body after decoding must be:

            {'id': &lt;a value greater than &lt;0&gt;&gt;, 'name': 'Bob'}
          ---------------------
  Actual: TestResponse:&lt;-----------
          - Status code is 200
          - Headers are the following:
            - content-encoding: gzip
            - content-length: 42
            - x-frame-options: SAMEORIGIN
            - content-type: application/json; charset=utf-8
            - x-xss-protection: 1; mode=block
            - x-content-type-options: nosniff
            - server: conduit/1
          Decoded body is:
          {id: 1, name: Fred}
          -------------------------
          &gt;
   Which: the body differs for the following reasons:
          was 'Fred' instead of 'Bob' at location ['name']
</code></pre>

<p>The 'Expected' value tells us the response we expected - that it has a status code of 200, any headers and the body must have a certain structure. The 'Actual' value tells us what the actual response was - a 200 OK, a bunch of headers, and a body a hero named 'Fred'. 'Which' tells us exactly what went wrong - we were expecting 'Bob', not 'Fred'. Let's update our test to expect 'Fred'.</p>
<pre class="codehilite"><code class="language-dart">test(&quot;POST /heroes returns 200 OK&quot;, () async {
  final response = await harness.agent.post(&quot;/heroes&quot;, body: {
    &quot;name&quot;: &quot;Fred&quot;
  });
  expectResponse(response, 200, body: {
    &quot;id&quot;: greaterThan(0),
    &quot;name&quot;: &quot;Fred&quot;
  });
});
</code></pre>

<p>We shouldn't just test success cases. Let's also expect that if we try and insert a hero with the same name, we get a 409 error response.</p>
<pre class="codehilite"><code class="language-dart">test(&quot;POST /heroes returns 200 OK&quot;, () async {
  await harness.agent.post(&quot;/heroes&quot;, body: {
    &quot;name&quot;: &quot;Fred&quot;
  });

  final badResponse = await harness.agent.post(&quot;/heroes&quot;, body: {
    &quot;name&quot;: &quot;Fred&quot;
  });
  expectResponse(badResponse, 409);
});
</code></pre>

<p>In this test, we request two 'Fred' heroes be created, and the second request fails with a 409 because <code>name</code> is a unique property of a hero. Notice that the first request didn't fail, even though we had created a 'Fred' hero in the previous test - that's because we reset the database for each test in our harness.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../storing-data/" class="btn btn-neutral float-left" title="3. Storing Data in a Database"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../oauth2/" class="btn btn-neutral float-right" title="5. Authentication and Authorization">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Built by Stable Kernel</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/stablekernel/aqueduct" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../storing-data/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../oauth2/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
